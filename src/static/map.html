<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Wind Turbine Map</title>
<style>
body{font-family:Arial, sans-serif;margin:0;padding:0;}
#upload{padding:1rem;text-align:center;}
#map-container{height:calc(100vh - 70px);width:100%;}
</style>
</head>
<body>
<div id="upload">
  <label>Turbines CSV/XLSX: <input type="file" id="turbines"></label>
  <label>Substation CSV: <input type="file" id="substation"></label>
  <label>Obstacles file: <input type="file" id="obstacles"></label>
  <button id="process-btn">Process</button>
  <span id="status"></span>
</div>
<div id="map-container"><iframe id="map-frame" style="width:100%;height:100%;border:none;"></iframe></div>
<script>
const turbinesInput = document.getElementById('turbines');
const substationInput = document.getElementById('substation');
const obstaclesInput = document.getElementById('obstacles');

function hexToBytes(hex){
  const arr = new Uint8Array(hex.length/2);
  for(let i=0;i<arr.length;i++){
    arr[i] = parseInt(hex.substr(i*2,2),16);
  }
  return arr;
}

document.getElementById('process-btn').addEventListener('click', async () => {
  const fd = new FormData();
  if (turbinesInput.files[0]) fd.append('turbines', turbinesInput.files[0]);
  if (substationInput.files[0]) fd.append('substation', substationInput.files[0]);
  if (obstaclesInput.files[0]) fd.append('obstacles', obstaclesInput.files[0]);
  if (![...fd.keys()].length) return;
  document.getElementById('status').textContent = 'Processing...';
  const resp = await fetch('/process/', {method:'POST', body: fd});
  if (!resp.ok){
    document.getElementById('status').textContent = 'Error processing file';
    return;
  }
  const data = await resp.json();
  const kmzBlob = new Blob([hexToBytes(data.route_kmz)], {type:'application/vnd.google-earth.kmz'});
  const kmzUrl = URL.createObjectURL(kmzBlob);
  document.getElementById('status').innerHTML = '<a href="'+kmzUrl+'" download="route.kmz">Download KMZ</a>';
  document.getElementById('map-frame').srcdoc = data.map;
});
</script>
</body>
</html>
